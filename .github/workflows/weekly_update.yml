name: Weekly Quant Engine Update

on:
  schedule:
    - cron: '0 3 * * 2'  # Ogni Marted√¨ alle 03:00 UTC
  workflow_dispatch:      # Esecuzione manuale

jobs:
  quant-pipeline:
    runs-on: ubuntu-latest
    
    steps:
      # 1. SETUP AMBIENTE
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          # Installa tutto ci√≤ che serve (uniamo i requirements per sicurezza)
          if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi
          if [ -f data-processing/requirements.txt ]; then pip install -r data-processing/requirements.txt; fi
          # Librerie critiche extra (nel caso mancassero nei txt)
          pip install pybind11 wikipedia dateparser sqlalchemy psycopg2-binary pandas python-dotenv scikit-learn soccerdata

      # 2. COMPILAZIONE MOTORE C++ (CRUCIALE)
      - name: Compile C++ Scouting Engine
        run: |
          cd backend
          # Compila similarity_engine.cpp. Se il tuo file si chiama quant_engine.cpp, cambia il nome qui sotto!
          c++ -O3 -Wall -shared -std=c++11 -fPIC $(python3 -m pybind11 --includes) similarity_engine.cpp -o similarity_engine$(python3-config --extension-suffix)
          ls -l similarity_engine*.so
          cd ..

      # 3. DEBUG DATABASE
      - name: Debug Database Connection
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
        run: echo "Connecting to DB at ${DB_HOST}..."

      # 4. PIPELINE DATI (ETL)
      
      # A. Scarico nuove partite e giocatori (V2 Schema)
      - name: 1. Ingest New Match Data (ETL V2)
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_PORT: ${{ secrets.DB_PORT }}
        run: |
          echo "‚öΩ Running Live ETL..."
          python data-processing/etl_live.py

      # B. Aggiornamento Contesto Squadre (ELO/Form)
      - name: 2. Update Team Context
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_PORT: ${{ secrets.DB_PORT }}
        run: |
          echo "üìà Updating Team ELO & Form..."
          python data-processing/etl_teams_context.py

      # C. Aggiornamento Et√† (Wikipedia)
      - name: 3. Fetch Missing Ages
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_PORT: ${{ secrets.DB_PORT }}
        run: |
          echo "üéÇ Fetching ages from Wikipedia..."
          # Assicurati che questo file esista in backend/
          python backend/fetch_ages.py

      # D. Calcolo Prezzi (Quant Engine)
      - name: 4. Calculate Fair Values (V3)
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_PORT: ${{ secrets.DB_PORT }}
        run: |
          echo "üí∞ Running Valuation Engine V3..."
          # Assicurati che questo file esista in backend/
          python backend/valuation_engine_v3.py

      # 5. NOTIFICHE
      - name: Notify Success
        if: success()
        run: echo "‚úÖ Weekly Update Completed Successfully!"
      
      - name: Notify Failure
        if: failure()
        run: echo "‚ùå Weekly Update Failed."